# ATP_re Testing Framework

This document describes the comprehensive testing framework for the ATP_re project.

## Overview

The testing framework includes:
- Unit tests for core decoder modules (RU, MMI)
- Integration tests for complete workflows
- Automated regression testing via CI/CD
- Code coverage reporting (target: 80%)

## Test Structure

```
ATP_re/
├── tests/
│   ├── java/              # Java unit tests
│   │   ├── decoder/       # Decoder module tests
│   │   ├── core/          # Core functionality tests
│   │   └── decode/        # Decode logic tests
│   ├── test_data/         # Test data files
│   │   ├── RU_file/       # Sample RU log files
│   │   └── MMI_file/      # Sample MMI files
│   └── test_results/      # Test execution results
├── pom.xml                # Maven build configuration
└── test_batch.sh          # Regression test runner
```

## Running Tests

### Unit Tests (Maven)

```bash
# Run all unit tests
mvn test

# Run tests with coverage report
mvn clean test jacoco:report

# Run specific test class
mvn test -Dtest=RUDecoderTest

# View coverage report
open target/site/jacoco/index.html
```

### Regression Tests (Bash)

```bash
# Run RU/MMI regression tests
./test_batch.sh

# Run with custom configuration
PROCESS_CMD="./my_decoder" TEST_DIR="./my_tests" ./test_batch.sh
```

## Test Categories

### 1. Unit Tests

**RU Decoder Tests** (`RUDecoderTest.java`)
- Packet header parsing
- Speed stamp parsing (ATPRU-LOGF-001 v1.8 compliant)
- MMI_DYNAMIC packet decoding
- BTM fragment handling
- Error handling for invalid/null packets

**MMI Decoder Tests** (`MMIDecoderTest.java`)
- Speed calculation (MMI_V_TRAIN)
- Acceleration calculation (MMI_A_TRAIN)
- Location calculation (MMI_O_TRAIN)
- Mode indicators (adhesion, level, brake)
- Edge case handling (negative values, max values, zero)

### 2. Integration Tests

**File Processing Tests**
- Complete RU file decoding
- Complete MMI file decoding
- Multi-file batch processing
- Output validation

### 3. Regression Tests

**Automated Regression**
- RU log file processing
- MMI file processing
- Output consistency checks
- Performance benchmarks

## Code Coverage

### Coverage Targets

- **Core Modules**: ≥ 95% coverage
  - RU Decoder
  - MMI Decoder
  - Packet parsers

- **Overall Project**: ≥ 80% coverage

### Coverage Reports

Coverage reports are generated by JaCoCo and can be viewed at:
```
target/site/jacoco/index.html
```

Key metrics tracked:
- Line coverage
- Branch coverage
- Method coverage
- Class coverage

## CI/CD Integration

### GitHub Actions Workflow

The project uses GitHub Actions for automated testing:

**Workflow: RU/MMI Regression Tests**
- Triggers: Push to main, Pull requests
- Steps:
  1. Checkout code
  2. Set up Java/Python environment
  3. Run unit tests with Maven
  4. Run regression tests with test_batch.sh
  5. Generate coverage reports
  6. Upload test artifacts

### Adding to CI/CD

To enhance the CI/CD pipeline:

```yaml
# .github/workflows/ru-mmi-regression.yml
- name: Run Unit Tests
  run: mvn clean test

- name: Generate Coverage Report
  run: mvn jacoco:report

- name: Upload Coverage
  uses: codecov/codecov-action@v3
  with:
    files: target/site/jacoco/jacoco.xml
```

## Writing Tests

### Test Template

```java
package decoder;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import static org.junit.jupiter.api.Assertions.*;

public class MyDecoderTest {
    
    private MyDecoder decoder;
    
    @BeforeEach
    public void setUp() {
        decoder = new MyDecoder();
    }
    
    @Test
    @DisplayName("Test description")
    public void testSomething() {
        // Arrange
        byte[] input = createTestData();
        
        // Act
        Object result = decoder.decode(input);
        
        // Assert
        assertNotNull(result);
        assertEquals(expectedValue, result.getValue());
    }
}
```

### Best Practices

1. **Use descriptive test names**: `testSpeedStampParsingAccordingToSpec()`
2. **Follow AAA pattern**: Arrange, Act, Assert
3. **Test edge cases**: null, empty, maximum values
4. **Use @DisplayName**: Make test output readable
5. **Keep tests independent**: No dependencies between tests
6. **Mock external dependencies**: Use test doubles when needed

## Test Data

### Creating Test Data

Test data should be placed in `test_data/` directory:

```bash
mkdir -p test_data/RU_file
mkdir -p test_data/MMI_file
```

**RU File Format**: Binary log files following ATPRU-LOGF-001 v1.8
**MMI File Format**: MMI packet data per Interface Specification

### Sample Data

Sample test files are provided in `tests/RU_file/` and `tests/MMI_file/`:
- `024423.RU` - Sample RU log file
- `114011` - Sample MMI file
- `120001` - Sample MMI file with multiple packets

## Continuous Improvement

### Coverage Goals

Current coverage status:
- RU Decoder: Target 95%
- MMI Decoder: Target 95%
- Overall: Target 80%

### Future Enhancements

- [ ] Performance benchmarking tests
- [ ] Stress testing with large files
- [ ] Property-based testing
- [ ] Mutation testing
- [ ] Integration with SonarQube
- [ ] Automated security scanning

## Troubleshooting

### Common Issues

**Tests not found**
- Ensure test files end with `Test.java`
- Check `testSourceDirectory` in pom.xml

**Coverage report missing**
- Run `mvn clean test jacoco:report`
- Check `target/site/jacoco/` directory

**CI/CD failures**
- Check workflow logs in GitHub Actions
- Verify test data files are committed
- Ensure all dependencies are specified

## References

- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
- [JaCoCo Documentation](https://www.jacoco.org/jacoco/trunk/doc/)
- [Maven Surefire Plugin](https://maven.apache.org/surefire/maven-surefire-plugin/)
- ATPRU-LOGF-001 RU Log File Data Format v1.8
- Interface Specification ATPCU-MMI 3NSS003791D0106 v3.2

## Contact

For questions about testing:
- Create an issue in GitHub
- Tag with `testing` label
- Reference this documentation
