# ATP è¡Œè»Šç´€éŒ„åˆ†æç³»çµ± - å®Œæ•´æŠ€è¡“è¦æ ¼æ›¸ v2.0

**ç‰ˆæœ¬ï¼š** 2.0 (Python é‡æ§‹ç‰ˆ)

**æ–‡ä»¶æ—¥æœŸï¼š** 2025-10-27

**åŸå§‹ç³»çµ±ç‰ˆæœ¬ï¼š** 1.0 (Java)

**é–‹ç™¼å–®ä½ï¼š** 

**æ’°å¯«è€…ï¼š** Lawliet

---

## ğŸ“‘ æ–‡ä»¶ç›®éŒ„

1. ç³»çµ±æ¦‚è¿°
2. ç³»çµ±æ¶æ§‹è¨­è¨ˆ
3. è§£ç¢¼é‚è¼¯è©³ç´°è¦æ ¼
4. è³‡æ–™çµæ§‹å®šç¾©
5. API è¨­è¨ˆè¦æ ¼
6. æ¸¬è©¦ç­–ç•¥                                                                      
7. Java â†’ Python å°ç…§æŒ‡å—
8. éƒ¨ç½²èˆ‡ç¶­è­·

---

## 1. ç³»çµ±æ¦‚è¿°

### 1.1 å°ˆæ¡ˆèƒŒæ™¯

**ç³»çµ±åç¨±ï¼š** ATP (Automatic Train Protection) è¡Œè»Šç´€éŒ„åˆ†æç³»çµ±

**é–‹ç™¼ç›®çš„ï¼š**

- è§£æ ATP ç³»çµ±ç”¢ç”Ÿçš„è¡Œè»Šç´€éŒ„è³‡æ–™ï¼ˆRU æª”æ¡ˆã€MMI æª”æ¡ˆï¼‰
- è¦–è¦ºåŒ–åˆ—è»Šé‹è¡Œè»Œè·¡ã€é€Ÿåº¦æ›²ç·šã€äº‹ä»¶è¨˜éŒ„
- æä¾›çµ„å“¡è€ƒæ ¸ã€å®‰å…¨åˆ†æã€ç•°å¸¸äº‹ä»¶åµæ¸¬åŠŸèƒ½
- ç”¢å‡ºç¬¦åˆè¦ç¯„çš„å ±è¡¨

**åŸå§‹ç³»çµ±ï¼š**

- é–‹ç™¼æ™‚é–“ï¼š2004-2012 å¹´
- é–‹ç™¼å» å•†ï¼šMiTAC Incï¼ˆç¥é€šé›»è…¦ï¼‰
- æŠ€è¡“æ£§ï¼šJava + Swing + JDBC
- ç¨‹å¼ç¢¼è¦æ¨¡ï¼šç´„ 50,000 è¡Œï¼Œ433 å€‹æª”æ¡ˆ

**é‡æ§‹ç›®æ¨™ï¼š**

- ä¿ç•™æ‰€æœ‰å·²é©—è­‰çš„è§£ç¢¼é‚è¼¯ï¼ˆ100% å°ç…§ç§»æ¤ï¼‰
- ä½¿ç”¨ Python é‡å¯«ï¼Œæå‡é–‹ç™¼æ•ˆç‡èˆ‡ç¶­è­·æ€§
- æ¡ç”¨ç¾ä»£åŒ– Web ä»‹é¢å–ä»£ Swing
- åˆ©ç”¨ Pandas åŠ é€Ÿè³‡æ–™è™•ç†
- ç¨‹å¼ç¢¼é‡é è¨ˆæ¸›å°‘ 90%

---

### 1.2 ç³»çµ±ç¯„åœ

**è¼¸å…¥è³‡æ–™ï¼š**

1. **RU æª”æ¡ˆ**ï¼ˆ.RU æ ¼å¼ï¼‰
    - Recording Unitï¼ˆè¨˜éŒ„å–®å…ƒï¼‰ç”¢ç”Ÿçš„äºŒé€²ä½æª”æ¡ˆ
    - åŒ…å«ï¼šATP å°åŒ…ã€BTM é›»å ±ã€VDX è¨Šè™Ÿ
    - æª”æ¡ˆå¤§å°ï¼šé€šå¸¸ 1-50 MB
2. **MMI æª”æ¡ˆ**ï¼ˆ.MMI æ ¼å¼ï¼‰
    - Man-Machine Interfaceï¼ˆäººæ©Ÿä»‹é¢ï¼‰è¨˜éŒ„
    - åŒ…å«ï¼šå¸æ©Ÿå“¡æ“ä½œã€ç³»çµ±ç‹€æ…‹ã€è­¦å‘Šè¨Šæ¯
    - æª”æ¡ˆå¤§å°ï¼šé€šå¸¸ 0.5-10 MB

**è™•ç†åŠŸèƒ½ï¼š**

1. **è³‡æ–™è§£ç¢¼**
    - 40+ ç¨® MMI å°åŒ…é¡å‹è§£æ
    - BTM é›»å ± 5 ç‰‡æ®µé‡çµ„
    - 19 ç¨® ETCS è·¯å´å°åŒ…è§£ç¢¼
2. **è³‡æ–™åˆ†æ**
    - é€Ÿåº¦æ›²ç·šåˆ†æ
    - è»Šç«™åœé åˆ¤æ–·
    - EB/SB äº‹ä»¶çµ±è¨ˆ
    - ç„¡ç«¯ SB åµæ¸¬
    - è¶…é€Ÿè­¦å‘Šåˆ†æ
3. **è¦–è¦ºåŒ–å‘ˆç¾**
    - æ™‚é–“æ¨¡å¼ / è·é›¢æ¨¡å¼é›™è»¸é¡¯ç¤º
    - é€Ÿåº¦æ›²ç·šã€ATP é™é€Ÿç·šã€ç›®æ¨™é€Ÿåº¦ç·š
    - äº‹ä»¶æ¨™è¨˜ï¼ˆEB/SB/æ•…éšœï¼‰
    - è»Šç«™èˆ‡ Balise ä½ç½®æ¨™ç¤º
    - å¡åº¦æ›²ç·šç–ŠåŠ 
4. **å ±è¡¨ç”¢å‡º**
    - çµ„å“¡è€ƒæ ¸å ±è¡¨
    - ç•°å¸¸äº‹ä»¶æ¸…å–®
    - çµ±è¨ˆæ‘˜è¦
    - åŒ¯å‡ºæ ¼å¼ï¼šCSV / Excel / PDF

**è¼¸å‡ºè³‡æ–™ï¼š**

- çµæ§‹åŒ–è³‡æ–™ï¼ˆè³‡æ–™åº«ï¼‰
- è¦–è¦ºåŒ–åœ–è¡¨ï¼ˆäº’å‹•å¼ç¶²é ï¼‰
- å ±è¡¨æª”æ¡ˆï¼ˆCSV/Excel/PDFï¼‰

---

### 1.3 ç³»çµ±é™åˆ¶èˆ‡å‡è¨­

**é™åˆ¶ï¼š**

1. åƒ…æ”¯æ´å°éµ ATP ç³»çµ±çš„è³‡æ–™æ ¼å¼ï¼ˆBombardier è¦æ ¼ï¼‰
2. RU/MMI æª”æ¡ˆå¿…é ˆå®Œæ•´ä¸”æœªæå£
3. è§£ç¢¼é‚è¼¯åŸºæ–¼ 2004-2012 å¹´çš„ç³»çµ±è¦æ ¼

**å‡è¨­ï¼š**

1. ATP ç³»çµ±ç”¢ç”Ÿçš„è³‡æ–™æ ¼å¼ä¿æŒç©©å®š
2. äºŒé€²ä½æª”æ¡ˆä½¿ç”¨ Big-Endian ä½å…ƒçµ„åº
3. æ™‚é–“æˆ³è¨˜æ¡ç”¨ YY-MM-DD HH:MM:SS æ ¼å¼ï¼ˆå¹´ä»½ + 2000ï¼‰
4. ä½ç½®è³‡è¨Šå–®ä½ç‚ºå…¬å°º
5. é€Ÿåº¦è³‡è¨Šå–®ä½ç‚º km/h

**ç›¸ä¾æ€§ï¼š**

1. Python 3.9+
2. è³‡æ–™åº«ï¼šPostgreSQL æˆ– SQLite
3. ç€è¦½å™¨ï¼šChrome/Firefox/Edgeï¼ˆæ”¯æ´ WebGLï¼‰

---

## 2. ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### 2.1 æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä½¿ç”¨è€…ä»‹é¢å±¤                          â”‚
â”‚   (Web UI - Streamlit / FastAPI + React)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ‡‰ç”¨é‚è¼¯å±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æª”æ¡ˆç®¡ç†    â”‚  â”‚  ä»»å‹™ç®¡ç†    â”‚  â”‚  å ±è¡¨ç”¢å‡º    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        è¦–è¦ºåŒ–å±¤                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  é€Ÿåº¦æ›²ç·š    â”‚  â”‚  äº‹ä»¶åœ–è¡¨    â”‚  â”‚  çµ±è¨ˆå„€è¡¨æ¿  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ¥­å‹™é‚è¼¯å±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è³‡æ–™åˆ†æ    â”‚  â”‚  äº‹ä»¶åµæ¸¬    â”‚  â”‚  çµ±è¨ˆè¨ˆç®—    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        è³‡æ–™å­˜å–å±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è³‡æ–™æ¨¡å‹    â”‚  â”‚  è³‡æ–™åº«DAO   â”‚  â”‚  å¿«å–ç®¡ç†    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        è§£ç¢¼å¼•æ“å±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  RU è§£ç¢¼å™¨   â”‚  â”‚  MMI è§£ç¢¼å™¨  â”‚  â”‚  BTM è§£ç¢¼å™¨  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æª”æ¡ˆè™•ç†å±¤                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æª”æ¡ˆè®€å–    â”‚  â”‚  æ ¼å¼é©—è­‰    â”‚  â”‚  ä½å…ƒçµ„è§£æ  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡çµ„è¨­è¨ˆ

### **æ¨¡çµ„ 1ï¼šæª”æ¡ˆè™•ç†å±¤ (file_handler)**

**è·è²¬ï¼š**

- è®€å– RU/MMI äºŒé€²ä½æª”æ¡ˆ
- é©—è­‰æª”æ¡ˆæ ¼å¼èˆ‡å®Œæ•´æ€§
- æä¾›ä½å…ƒçµ„æµå­˜å–ä»‹é¢

**ä¸»è¦é¡åˆ¥ï¼š**

```python
# file_handler/ru_file_[reader.py](http://reader.py)
class RUFileReader:
    """RU æª”æ¡ˆè®€å–å™¨"""
    def read(self, file_path: str) -> bytes
    def validate(self, data: bytes) -> bool
    def get_file_info(self, file_path: str) -> dict
```

**å°æ‡‰ Java åŸå§‹ç¢¼ï¼š**

- `decoder_re/[DataFeeder.java](http://DataFeeder.java)`
- `decoder_re/[FileRead.java](http://FileRead.java)`

---

### **æ¨¡çµ„ 2ï¼šè§£ç¢¼å¼•æ“å±¤ (decoder)**

**è·è²¬ï¼š**

- è§£æäºŒé€²ä½è³‡æ–™ç‚ºçµæ§‹åŒ–è³‡è¨Š
- è™•ç† 40+ ç¨® MMI å°åŒ…é¡å‹
- BTM 5 ç‰‡æ®µé‡çµ„
- ETCS è·¯å´å°åŒ…è§£ç¢¼

**ä¸»è¦é¡åˆ¥è«‹è¦‹å®Œæ•´è¦æ ¼æ›¸ç¬¬ 3 ç« **

**å°æ‡‰ Java åŸå§‹ç¢¼ï¼š**

- `decode_re/[Decoder.java](http://Decoder.java)`
- `decode_re/[DecodeATP.java](http://DecodeATP.java)`
- `decoder_re/[HeadDecoder.java](http://HeadDecoder.java)`
- `decoder_re/[BTMDecoder.java](http://BTMDecoder.java)`
- `decoder_re/waySidePacket/*.java`ï¼ˆ19 å€‹æª”æ¡ˆï¼‰

---

## 3. è§£ç¢¼é‚è¼¯è©³ç´°è¦æ ¼

### 3.1 RU æª”æ¡ˆæ ¼å¼

### 3.1.1 æª”æ¡ˆçµæ§‹

```
RU æª”æ¡ˆ (.MMI)
â”œâ”€ è¨˜éŒ„é›†åˆ (Records)
â”‚  â”œâ”€ è¨˜éŒ„ 1
â”‚  â”‚  â”œâ”€ æ¨™é ­ (15 bytes)
â”‚  â”‚  â””â”€ è³‡æ–™ (è®Šé•·)
â”‚  â”œâ”€ è¨˜éŒ„ 2
â”‚  â”‚  â””â”€ ...
â”‚  â””â”€ è¨˜éŒ„ N
```

### 3.1.2 è¨˜éŒ„æ¨™é ­æ ¼å¼ (15 bytes)

| ä½å…ƒçµ„ | æ¬„ä½ | å‹åˆ¥ | èªªæ˜ | Java å°ç…§ |
| --- | --- | --- | --- | --- |
| 0 | å¹´ä»½ | uint8 | YY (éœ€åŠ  2000) | `data[pos]` |
| 1 | æœˆä»½ | uint8 | MM (1-12) | `data[pos+1]` |
| 2 | æ—¥æœŸ | uint8 | DD (1-31) | `data[pos+2]` |
| 3 | å°æ™‚ | uint8 | HH (0-23) | `data[pos+3]` |
| 4 | åˆ†é˜ | uint8 | mm (0-59) | `data[pos+4]` |
| 5 | ç§’æ•¸ | uint8 | ss (0-59) | `data[pos+5]` |
| 6-7 | é€Ÿåº¦ | uint16 | å–®ä½: 0.1 km/h | `DecodeATP.getIntFromByte2()` |
| 8-11 | ä½ç½® | uint32 | å–®ä½: å…¬å°º | `DecodeATP.getIntFromByte4()` |
| 12-13 | å°åŒ…é•·åº¦ | uint16 | å«æ¨™é ­çš„ç¸½é•·åº¦ | `data[pos+12] << 8 |
| 14 | å°åŒ…é¡å‹ | uint8 | 0x50=ATP, 0xA0=MMI | `data[pos+14]` |

**Python å¯¦ä½œç¯„ä¾‹:**

```python
@dataclass
class RecordHeader:
    timestamp: datetime
    speed: float  # km/h
    position: int  # meters
    packet_length: int
    packet_type: int
    
    @classmethod
    def parse(cls, data: bytes) -> 'RecordHeader':
        year = data[0] + 2000
        month = data[1]
        day = data[2]
        hour = data[3]
        minute = data[4]
        second = data[5]
        
        timestamp = datetime(year, month, day, hour, minute, second)
        speed = struct.unpack('>H', data[6:8])[0] / 10.0
        position = struct.unpack('>I', data[8:12])[0]
        packet_length = struct.unpack('>H', data[12:14])[0]
        packet_type = data[14]
        
        return cls(timestamp, speed, position, packet_length, packet_type)
```

**Java å°ç…§:**

- `decode_re/[DecodeATP.java](http://DecodeATP.java)`: `getIntFromByte2()`, `getIntFromByte4()`
- `decoder_re/[HeadDecoder.java](http://HeadDecoder.java)`: `decodeHead()`

### 3.2 MMI å°åŒ…è§£ç¢¼è¦æ ¼

### 3.2.1 å°åŒ…é¡å‹å®šç¾©

| é¡å‹ç¢¼ | å°åŒ…åç¨± | å„ªå…ˆç´š | èªªæ˜ |
| --- | --- | --- | --- |
| 1 | MMI_DYNAMIC | â­â­â­ | å‹•æ…‹è³‡æ–™(é€Ÿåº¦/ä½ç½®/æ™‚é–“) |
| 2 | MMI_STATUS | â­â­â­ | ç³»çµ±ç‹€æ…‹ |
| 3 | MMI_TRACK_DESCRIPTION | â­â­ | è»Œé“æè¿° |
| 4 | MMI_TRACK_DATA | â­ | è»Œé“è³‡æ–™ |
| 5 | MMI_TRACK_AHEAD_FREE | â­ | å‰æ–¹è»Œé“æ·¨ç©º |
| 6 | MMI_DRIVER_REQUEST | â­â­ | å¸æ©Ÿå“¡è«‹æ±‚ |
| 7 | MMI_DRIVER_ACTION | â­â­ | å¸æ©Ÿå“¡å‹•ä½œ |
| 8 | MMI_DRIVER_MESSAGE | â­â­â­ | å¸æ©Ÿå“¡è¨Šæ¯ |
| 9 | MMI_FAILURE_REPORT_ATP | â­â­â­ | ATP æ•…éšœå ±å‘Š |
| 10 | MMI_FAILURE_REPORT_BTM | â­â­ | BTM æ•…éšœå ±å‘Š |
| 11 | MMI_SET_TIME | â­ | æ™‚é–“è¨­å®š |
| 12 | MMI_ECHO | â­ | Echo å°åŒ… |
| 19 | MMI_ICON | â­ | åœ–ç¤ºé¡¯ç¤º |
| 20 | MMI_GEOLOCATION | â­â­ | åœ°ç†ä½ç½® |
| 25 | MMI_NTC_STATUS | â­ | NTC ç‹€æ…‹ |

### 3.2.2 MMI_DYNAMIC (å°åŒ… 1) - æœ€é‡è¦çš„å°åŒ…

**è³‡æ–™é•·åº¦:** 15 bytes (å›ºå®š)

**è³‡æ–™æ ¼å¼:**

| ä½å…ƒçµ„ | æ¬„ä½ | å‹åˆ¥ | å–®ä½ | èªªæ˜ |
| --- | --- | --- | --- | --- |
| 0-1 | V_TRAIN | uint16 | 0.1 km/h | åˆ—è»Šé€Ÿåº¦ |
| 2-5 | L_TRAIN_POS | int32 | cm | åˆ—è»Šä½ç½® |
| 6-9 | L_TRAIN_POS_FRONT | int32 | cm | åˆ—è»Šå‰ç«¯ä½ç½® |
| 10-13 | T_TRAIN | uint32 | ms | åˆ—è»Šæ™‚é–“ (UTC) |
| 14 | M_MODE | uint8 | - | ç³»çµ±æ¨¡å¼ |

**æ¨¡å¼å®šç¾© (M_MODE):**

```python
class ATPMode(Enum):
    FULL_SUPERVISION = 0      # FS - å®Œå…¨ç›£æ§
    ON_SIGHT = 1              # OS - ç›®è¦–è¡Œé§›
    STAFF_RESPONSIBLE = 2     # SR - å¸æ©Ÿå“¡è²¬ä»»
    SHUNTING = 3              # SH - èª¿è»Š
    UNFITTED = 4              # UN - æœªè£å‚™
    STANDBY = 5               # SB - å¾…å‘½
    TRIP = 6                  # TR - è·³è„«
    POST_TRIP = 7             # PT - è·³è„«å¾Œ
    SYSTEM_FAILURE = 8        # SF - ç³»çµ±æ•…éšœ
    ISOLATION = 9             # IS - éš”é›¢
    NON_LEADING = 10          # NL - éä¸»æ§
    LIMITED_SUPERVISION = 11  # LS - æœ‰é™ç›£æ§
```

**Python å¯¦ä½œ:**

```python
@dataclass
class MMIDynamic:
    v_train: float          # km/h
    l_train_pos: int        # cm
    l_train_pos_front: int  # cm
    t_train: int            # ms (UTC)
    m_mode: ATPMode
    
    @classmethod
    def decode(cls, data: bytes) -> 'MMIDynamic':
        v_train = struct.unpack('>H', data[0:2])[0] / 10.0
        l_train_pos = struct.unpack('>i', data[2:6])[0]
        l_train_pos_front = struct.unpack('>i', data[6:10])[0]
        t_train = struct.unpack('>I', data[10:14])[0]
        m_mode = ATPMode(data[14])
        
        return cls(v_train, l_train_pos, l_train_pos_front, t_train, m_mode)
```

**Java å°ç…§:**

- `decode_re/[PacketMMI.java](http://PacketMMI.java)`: `setPacketOne()` æ–¹æ³•
- è®Šæ•¸åç¨±å°ç…§:
    - Java: `v_train`, `l_train_location`, `l_train_location_front`
    - Python: ä¿æŒç›¸åŒå‘½å

### 3.2.3 MMI_STATUS (å°åŒ… 2)

**è³‡æ–™é•·åº¦:** å¯è®Š (æœ€å°‘ 13 bytes)

**æ ¸å¿ƒæ¬„ä½:**

| ä½å…ƒçµ„ | æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| 0 | M_LEVEL | uint8 | ETCS Level (0/1/2/3) |
| 1 | M_MODE | uint8 | ATP æ¨¡å¼ |
| 2-3 | V_PERMITTED | uint16 | å…è¨±é€Ÿåº¦ (0.1 km/h) |
| 4-5 | V_TARGET | uint16 | ç›®æ¨™é€Ÿåº¦ (0.1 km/h) |
| 6-7 | V_RELEASE | uint16 | é‡‹æ”¾é€Ÿåº¦ (0.1 km/h) |
| 8-11 | D_TARGET | int32 | ç›®æ¨™è·é›¢ (cm) |
| 12 | Q_TEXT_CLASS | uint8 | æ–‡å­—é¡åˆ¥ |

**Python å¯¦ä½œ:**

```python
@dataclass
class MMIStatus:
    m_level: int
    m_mode: ATPMode
    v_permitted: float  # km/h
    v_target: float     # km/h
    v_release: float    # km/h
    d_target: int       # cm
    q_text_class: int
    
    @classmethod
    def decode(cls, data: bytes) -> 'MMIStatus':
        return cls(
            m_level=data[0],
            m_mode=ATPMode(data[1]),
            v_permitted=struct.unpack('>H', data[2:4])[0] / 10.0,
            v_target=struct.unpack('>H', data[4:6])[0] / 10.0,
            v_release=struct.unpack('>H', data[6:8])[0] / 10.0,
            d_target=struct.unpack('>i', data[8:12])[0],
            q_text_class=data[12]
        )
```

### 3.2.4 MMI_DRIVER_MESSAGE (å°åŒ… 8)

**ç”¨é€”:** è¨˜éŒ„ç³»çµ±è¨Šæ¯ã€è­¦å‘Šã€éŒ¯èª¤

**è³‡æ–™æ ¼å¼:**

| ä½å…ƒçµ„ | æ¬„ä½ | å‹åˆ¥ | èªªæ˜ |
| --- | --- | --- | --- |
| 0 | Q_TEXT | uint8 | è¨Šæ¯ID |
| 1 | Q_TEXT_CLASS | uint8 | è¨Šæ¯é¡åˆ¥ |
| 2 | Q_TEXT_CRITERIA | uint8 | é¡¯ç¤ºæ¢ä»¶ |
| 3-N | TEXT | string | UTF-8 æ–‡å­— (å¯é¸) |

**è¨Šæ¯é¡åˆ¥ (Q_TEXT_CLASS):**

```python
class MessageClass(Enum):
    AUXILIARY_INFO = 0      # è¼”åŠ©è³‡è¨Š
    IMPORTANT_INFO = 1      # é‡è¦è³‡è¨Š  
    LEVEL_1_WARNING = 2     # Level 1 è­¦å‘Š
    LEVEL_2_WARNING = 3     # Level 2 è­¦å‘Š
```

**å¸¸è¦‹è¨Šæ¯ ID (Q_TEXT):**

- 256: "EB ä½œç”¨" (Emergency Brake)
- 257: "SB ä½œç”¨" (Service Brake)
- 258: "è¶…é€Ÿè­¦å‘Š"
- 259: "ATP æ•…éšœ"
- 260: "BTM æ•…éšœ"

**Python å¯¦ä½œ:**

```python
@dataclass
class MMIDriverMessage:
    q_text: int
    q_text_class: MessageClass
    q_text_criteria: int
    text: str = ""
    
    @classmethod
    def decode(cls, data: bytes) -> 'MMIDriverMessage':
        q_text = data[0]
        q_text_class = MessageClass(data[1])
        q_text_criteria = data[2]
        text = data[3:].decode('utf-8', errors='ignore').rstrip('\x00')
        
        return cls(q_text, q_text_class, q_text_criteria, text)
```

### 3.3 BTM é›»å ±è§£ç¢¼è¦æ ¼

### 3.3.1 BTM 5 ç‰‡æ®µé‡çµ„æ©Ÿåˆ¶

**èƒŒæ™¯:**

- BTM é›»å ±æœ€å¤§ 1023 bits,é€éç„¡ç·šå‚³è¼¸å¯èƒ½åˆ†æ•£åœ¨ 5 å€‹ç‰‡æ®µ
- å¿…é ˆæ”¶é›†å®Œæ•´ 5 å€‹ç‰‡æ®µæ‰èƒ½é‡çµ„å®Œæ•´é›»å ±

**ç‰‡æ®µæ ¼å¼:**

| ä½å…ƒçµ„ | æ¬„ä½ | èªªæ˜ |
| --- | --- | --- |
| 0 | FRAGMENT_ID | ç‰‡æ®µç·¨è™Ÿ (0-4) |
| 1-N | DATA | ç‰‡æ®µè³‡æ–™ |

**é‡çµ„æ¼”ç®—æ³•:**

```python
class BTMReassembler:
    def __init__(self):
        self.fragments = {}  # {telegram_id: {fragment_id: data}}
        
    def add_fragment(self, telegram_id: int, fragment_id: int, data: bytes) -> Optional[bytes]:
        """
        åŠ å…¥ç‰‡æ®µ,ç•¶æ”¶é›†å®Œ 5 å€‹ç‰‡æ®µæ™‚è¿”å›å®Œæ•´é›»å ±
        """
        if telegram_id not in self.fragments:
            self.fragments[telegram_id] = {}
        
        self.fragments[telegram_id][fragment_id] = data
        
        # æª¢æŸ¥æ˜¯å¦æ”¶é›†å®Œæ•´
        if len(self.fragments[telegram_id]) == 5:
            # æŒ‰ç…§ç‰‡æ®µ ID é †åºçµ„åˆ
            complete_telegram = b''.join(
                self.fragments[telegram_id][i] for i in range(5)
            )
            
            # æ¸…é™¤å·²é‡çµ„çš„ç‰‡æ®µ
            del self.fragments[telegram_id]
            
            return complete_telegram
        
        return None
```

**Java å°ç…§:**

- `decoder_re/[BTMDecoder.java](http://BTMDecoder.java)`: `collectFragments()` æ–¹æ³•
- ä½¿ç”¨ `HashMap<Integer, List<byte[]>>` å„²å­˜ç‰‡æ®µ

### 3.3.2 ETCS è·¯å´å°åŒ…æ ¼å¼

**Balise é›»å ±çµæ§‹:**

```
é›»å ± (Telegram)
â”œâ”€ é›»å ±æ¨™é ­ (10 bytes)
â”œâ”€ å°åŒ… 1 (P3 - Movement Authority)
â”œâ”€ å°åŒ… 2 (P27 - Speed Profile)  
â”œâ”€ å°åŒ… 3 (P44 - Data Used By Applications)
â””â”€ ...
```

**é›»å ±æ¨™é ­æ ¼å¼:**

| ä½å…ƒ | é•·åº¦ | æ¬„ä½ | èªªæ˜ |
| --- | --- | --- | --- |
| 0-9 | 10 bits | Q_UPDOWN | æ–¹å‘ (ä¸Šè¡Œ/ä¸‹è¡Œ) |
| 10-23 | 14 bits | M_VERSION | ETCS ç‰ˆæœ¬ |
| 24-33 | 10 bits | Q_MEDIA | åª’é«”é¡å‹ |
| 34-47 | 14 bits | N_PIG | Balise ç¾¤çµ„ç·¨è™Ÿ |
| 48-50 | 3 bits | N_TOTAL | ç¸½ Balise æ•¸ |
| 51-53 | 3 bits | M_DUP | é‡è¤‡æ¨™è¨˜ |
| 54-55 | 2 bits | M_MCOUNT | è¨Šæ¯è¨ˆæ•¸ |
| 56-79 | 24 bits | NID_C | åœ‹å®¶ä»£ç¢¼ |
| 80-93 | 14 bits | NID_BG | Balise ç¾¤çµ„ID |

**Python å¯¦ä½œ:**

```python
@dataclass
class TelegramHeader:
    q_updown: int      # 0=ä¸Šè¡Œ, 1=ä¸‹è¡Œ
    m_version: int     # ETCS ç‰ˆæœ¬
    q_media: int       # åª’é«”é¡å‹
    n_pig: int         # Balise ç·¨è™Ÿ
    n_total: int       # ç¾¤çµ„ç¸½æ•¸
    m_dup: int         # é‡è¤‡æ¨™è¨˜
    m_mcount: int      # è¨Šæ¯è¨ˆæ•¸
    nid_c: int         # åœ‹å®¶ä»£ç¢¼
    nid_bg: int        # Balise ç¾¤çµ„ ID
    
    @classmethod
    def parse(cls, bits: str) -> 'TelegramHeader':
        """
        å¾ bit string è§£ææ¨™é ­
        bits: '01001110...' (94 bits)
        """
        return cls(
            q_updown=int(bits[0:10], 2),
            m_version=int(bits[10:24], 2),
            q_media=int(bits[24:34], 2),
            n_pig=int(bits[34:48], 2),
            n_total=int(bits[48:51], 2),
            m_dup=int(bits[51:54], 2),
            m_mcount=int(bits[54:56], 2),
            nid_c=int(bits[56:80], 2),
            nid_bg=int(bits[80:94], 2)
        )
```

### 3.3.3 é‡è¦å°åŒ…é¡å‹

**P3 - Movement Authority (è¡Œè»Šæ¬Šé™)**

| ä½å…ƒ | é•·åº¦ | æ¬„ä½ | èªªæ˜ |
| --- | --- | --- | --- |
| 0-7 | 8 | NID_PACKET | å°åŒ…ID = 3 |
| 8-20 | 13 | Q_DIR | æ–¹å‘ |
| 21-35 | 15 | L_PACKET | å°åŒ…é•·åº¦ |
| 36-50 | 15 | Q_SCALE | æ¯”ä¾‹å°º |
| 51-65 | 15 | V_LOA | æœ€ä½å…è¨±é€Ÿåº¦ |
| 66-80 | 15 | T_LOA | æ™‚é–“é™åˆ¶ |
| 81-95 | 15 | N_ITER | å€æ®µæ•¸é‡ |
| 96+ | var | SECTIONS | é€Ÿåº¦å€æ®µåˆ—è¡¨ |

**P27 - Speed Profile (é€Ÿåº¦é™åˆ¶)**

| ä½å…ƒ | é•·åº¦ | æ¬„ä½ | èªªæ˜ |
| --- | --- | --- | --- |
| 0-7 | 8 | NID_PACKET | å°åŒ…ID = 27 |
| 8-20 | 13 | Q_DIR | æ–¹å‘ |
| 21-35 | 15 | L_PACKET | å°åŒ…é•·åº¦ |
| 36-50 | 15 | Q_SCALE | æ¯”ä¾‹å°º |
| 51-57 | 7 | D_STATIC | éœæ…‹é€Ÿåº¦å€æ®µé•·åº¦ |
| 58-64 | 7 | V_STATIC | éœæ…‹é€Ÿåº¦å€¼ |
| 65-71 | 7 | Q_FRONT | åˆ—è»Šå‰ç«¯æ¨™è¨˜ |
| 72-76 | 5 | N_ITER | é€Ÿåº¦å€æ®µæ•¸é‡ |
| 77+ | var | PROFILES | é€Ÿåº¦æ›²ç·šåˆ—è¡¨ |

**Python å¯¦ä½œ:**

```python
@dataclass
class P3_MovementAuthority:
    nid_packet: int = 3
    q_dir: int = 0
    l_packet: int = 0
    q_scale: int = 0
    v_loa: int = 0
    t_loa: int = 0
    sections: List['MASection'] = field(default_factory=list)
    
    @classmethod
    def parse(cls, bits: str) -> 'P3_MovementAuthority':
        # å¯¦ä½œå°åŒ…è§£æé‚è¼¯
        pass

@dataclass  
class P27_SpeedProfile:
    nid_packet: int = 27
    q_dir: int = 0
    l_packet: int = 0
    q_scale: int = 0
    d_static: int = 0
    v_static: int = 0
    q_front: int = 0
    profiles: List['SpeedSection'] = field(default_factory=list)
    
    @classmethod
    def parse(cls, bits: str) -> 'P27_SpeedProfile':
        # å¯¦ä½œå°åŒ…è§£æé‚è¼¯
        pass
```

**Java å°ç…§:**

- `decoder_re/waySidePacket/P3_[MovementAuthority.java](http://MovementAuthority.java)`
- `decoder_re/waySidePacket/P27_[SpeedProfile.java](http://SpeedProfile.java)`
- å…± 19 å€‹å°åŒ…é¡åˆ¥ (P3, P5, P12, P15, P21, P27, P41, P42, P44, P45, P58, P63, P64, P65, P66, P67, P68, P72, P80)

### 3.4 VDX æ•¸ä½è¨Šè™Ÿè§£ç¢¼

**VDX (Digital I/O Signals):** åˆ—è»Šæ•¸ä½è¼¸å…¥è¼¸å‡ºè¨Šè™Ÿ

**è¨Šè™Ÿé¡å‹:**

| ä½å…ƒ | è¨Šè™Ÿåç¨± | èªªæ˜ |
| --- | --- | --- |
| 0 | EB_CMD | ç·Šæ€¥ç…è»ŠæŒ‡ä»¤ |
| 1 | SB_CMD | å¸¸ç”¨ç…è»ŠæŒ‡ä»¤ |
| 2 | WARNING | è­¦å‘Šè¨Šè™Ÿ |
| 3 | ISOLATION | éš”é›¢ç‹€æ…‹ |
| 4 | DOOR_CLOSED | è»Šé–€é—œé–‰ |
| 5 | TRACTION_CUT | ç‰½å¼•åˆ‡æ–· |
| 6-7 | RESERVED | ä¿ç•™ |

**Python å¯¦ä½œ:**

```python
@dataclass
class VDXSignals:
    eb_cmd: bool       # ç·Šæ€¥ç…è»ŠæŒ‡ä»¤
    sb_cmd: bool       # å¸¸ç”¨ç…è»ŠæŒ‡ä»¤
    warning: bool      # è­¦å‘Š
    isolation: bool    # éš”é›¢
    door_closed: bool  # è»Šé–€é—œé–‰
    traction_cut: bool # ç‰½å¼•åˆ‡æ–·
    
    @classmethod
    def decode(cls, byte_value: int) -> 'VDXSignals':
        return cls(
            eb_cmd=bool(byte_value & 0x01),
            sb_cmd=bool(byte_value & 0x02),
            warning=bool(byte_value & 0x04),
            isolation=bool(byte_value & 0x08),
            door_closed=bool(byte_value & 0x10),
            traction_cut=bool(byte_value & 0x20)
        )
```

---

## 4. è³‡æ–™çµæ§‹å®šç¾©

### 4.1 æ ¸å¿ƒè³‡æ–™æ¨¡å‹

### 4.1.1 ATPMission (ä»»å‹™)

```python
@dataclass
class ATPMission:
    """ä»£è¡¨ä¸€æ¬¡å®Œæ•´çš„è¡Œè»Šä»»å‹™"""
    
    # åŸºæœ¬è³‡è¨Š
    id: str                    # ä»»å‹™ ID (UUID)
    ru_filename: str           # RU æª”æ¡ˆåç¨±
    mmi_filename: str          # MMI æª”æ¡ˆåç¨±
    upload_time: datetime      # ä¸Šå‚³æ™‚é–“
    
    # è¡Œè»Šè³‡è¨Š
    train_number: str          # è»Šæ¬¡
    driver_name: str           # å¸æ©Ÿå“¡å§“å
    start_station: str         # èµ·ç«™
    end_station: str           # è¿„ç«™
    start_time: datetime       # ç™¼è»Šæ™‚é–“
    end_time: datetime         # åˆ°ç«™æ™‚é–“
    
    # è³‡æ–™é›†åˆ
    records: List[Record]      # æ‰€æœ‰è¨˜éŒ„
    events: List[Event]        # äº‹ä»¶åˆ—è¡¨
    stations: List[Station]    # è»Šç«™åˆ—è¡¨
    balises: List[Balise]      # Balise åˆ—è¡¨
    
    # çµ±è¨ˆè³‡è¨Š
    total_distance: int        # ç¸½è·é›¢ (m)
    max_speed: float           # æœ€é«˜é€Ÿåº¦ (km/h)
    avg_speed: float           # å¹³å‡é€Ÿåº¦ (km/h)
    eb_count: int              # EB æ¬¡æ•¸
    sb_count: int              # SB æ¬¡æ•¸
    warning_count: int         # è­¦å‘Šæ¬¡æ•¸
    
    # ç‹€æ…‹
    status: str                # è™•ç†ç‹€æ…‹
    error_message: str = ""    # éŒ¯èª¤è¨Šæ¯
```

### 4.1.2 Record (è¨˜éŒ„)

```python
@dataclass
class Record:
    """å–®ç­†è¨˜éŒ„"""
    
    # æ¨™é ­è³‡è¨Š
    timestamp: datetime        # æ™‚é–“æˆ³è¨˜
    speed: float               # é€Ÿåº¦ (km/h)
    position: int              # ä½ç½® (m)
    packet_type: int           # å°åŒ…é¡å‹
    
    # å°åŒ…è³‡æ–™
    packet_data: Union[
        MMIDynamic,
        MMIStatus,
        MMIDriverMessage,
        BTMTelegram,
        VDXSignals,
        bytes  # æœªè§£æçš„åŸå§‹è³‡æ–™
    ]
    
    # è¡ç”Ÿè³‡è¨Š
    acceleration: float = 0.0  # åŠ é€Ÿåº¦ (m/sÂ²)
    gradient: float = 0.0      # å¡åº¦ (â€°)
    mode: ATPMode = ATPMode.STANDBY  # ATP æ¨¡å¼
```

### 4.1.3 Event (äº‹ä»¶)

```python
class EventType(Enum):
    """äº‹ä»¶é¡å‹"""
    EB = "EB"                  # ç·Šæ€¥ç…è»Š
    SB = "SB"                  # å¸¸ç”¨ç…è»Š
    WARNING = "WARNING"        # è­¦å‘Š
    OVERSPEED = "OVERSPEED"    # è¶…é€Ÿ
    ATP_FAULT = "ATP_FAULT"    # ATP æ•…éšœ
    BTM_FAULT = "BTM_FAULT"    # BTM æ•…éšœ
    MODE_CHANGE = "MODE_CHANGE" # æ¨¡å¼åˆ‡æ›
    STATION_STOP = "STATION_STOP" # è»Šç«™åœè»Š
    
@dataclass
class Event:
    """äº‹ä»¶è¨˜éŒ„"""
    
    id: str                    # äº‹ä»¶ ID
    mission_id: str            # æ‰€å±¬ä»»å‹™
    event_type: EventType      # äº‹ä»¶é¡å‹
    timestamp: datetime        # ç™¼ç”Ÿæ™‚é–“
    position: int              # ç™¼ç”Ÿä½ç½® (m)
    speed: float               # ç•¶æ™‚é€Ÿåº¦ (km/h)
    
    # äº‹ä»¶è©³ç´°è³‡è¨Š
    description: str           # äº‹ä»¶æè¿°
    severity: int              # åš´é‡ç¨‹åº¦ (1-5)
    related_records: List[int] # ç›¸é—œè¨˜éŒ„ ID
    
    # åˆ†æè³‡è¨Š
    is_valid: bool = True      # æ˜¯å¦æœ‰æ•ˆäº‹ä»¶
    is_false_positive: bool = False  # æ˜¯å¦èª¤åˆ¤
    note: str = ""             # å‚™è¨»
```

### 4.1.4 Station (è»Šç«™)

```python
@dataclass
class Station:
    """è»Šç«™è³‡è¨Š"""
    
    id: str                    # è»Šç«™ ID
    name: str                  # è»Šç«™åç¨±
    position: int              # ä½ç½® (m)
    platform_start: int        # æœˆå°èµ·é» (m)
    platform_end: int          # æœˆå°çµ‚é» (m)
    
    # åœè»Šè³‡è¨Š
    arrival_time: Optional[datetime] = None     # åˆ°é”æ™‚é–“
    departure_time: Optional[datetime] = None   # ç™¼è»Šæ™‚é–“
    stop_position: Optional[int] = None         # åœè»Šä½ç½® (m)
    is_in_platform: bool = False                # æ˜¯å¦åœåœ¨æœˆå°å…§
    
    # åˆ†æè³‡è¨Š
    overrun_distance: int = 0  # è¶…éåœè»Šé»è·é›¢ (m)
    stop_accuracy_grade: str = "" # åœè»Šç²¾æº–åº¦ç­‰ç´š
```

### 4.1.5 Balise (æ‡‰ç­”å™¨)

```python
@dataclass  
class Balise:
    """Balise æ‡‰ç­”å™¨"""
    
    id: str                    # Balise ID
    nid_bg: int                # Balise ç¾¤çµ„ ID
    position: int              # ä½ç½® (m)
    direction: int             # æ–¹å‘ (0=ä¸Šè¡Œ, 1=ä¸‹è¡Œ)
    
    # é›»å ±è³‡è¨Š
    telegram_count: int = 0    # æ”¶åˆ°é›»å ±æ•¸
    last_telegram_time: Optional[datetime] = None
    
    # å°åŒ…è³‡æ–™
    movement_authority: Optional[P3_MovementAuthority] = None
    speed_profile: Optional[P27_SpeedProfile] = None
    gradient_profile: Optional[P21_GradientProfile] = None
    
    # ç‹€æ…‹
    is_valid: bool = True      # æ˜¯å¦æœ‰æ•ˆ
    error_count: int = 0       # éŒ¯èª¤æ¬¡æ•¸
```

### 4.2 è³‡æ–™åº« Schema

### 4.2.1 PostgreSQL Schema

```sql
-- ä»»å‹™è¡¨
CREATE TABLE missions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    ru_filename VARCHAR(255) NOT NULL,
    mmi_filename VARCHAR(255) NOT NULL,
    upload_time TIMESTAMP NOT NULL DEFAULT NOW(),
    
    train_number VARCHAR(50),
    driver_name VARCHAR(100),
    start_station VARCHAR(100),
    end_station VARCHAR(100),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    
    total_distance INTEGER,
    max_speed FLOAT,
    avg_speed FLOAT,
    eb_count INTEGER DEFAULT 0,
    sb_count INTEGER DEFAULT 0,
    warning_count INTEGER DEFAULT 0,
    
    status VARCHAR(50) DEFAULT 'pending',
    error_message TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_missions_train_number ON missions(train_number);
CREATE INDEX idx_missions_driver_name ON missions(driver_name);
CREATE INDEX idx_missions_upload_time ON missions(upload_time);

-- è¨˜éŒ„è¡¨
CREATE TABLE records (
    id BIGSERIAL PRIMARY KEY,
    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
    
    timestamp TIMESTAMP NOT NULL,
    speed FLOAT NOT NULL,
    position INTEGER NOT NULL,
    packet_type SMALLINT NOT NULL,
    
    -- å°åŒ…è³‡æ–™ (JSON æ ¼å¼)
    packet_data JSONB,
    
    acceleration FLOAT DEFAULT 0.0,
    gradient FLOAT DEFAULT 0.0,
    mode VARCHAR(50),
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_records_mission_id ON records(mission_id);
CREATE INDEX idx_records_timestamp ON records(timestamp);
CREATE INDEX idx_records_position ON records(position);
CREATE INDEX idx_records_packet_data ON records USING gin(packet_data);

-- äº‹ä»¶è¡¨
CREATE TABLE events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
    
    event_type VARCHAR(50) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    position INTEGER NOT NULL,
    speed FLOAT NOT NULL,
    
    description TEXT,
    severity INTEGER CHECK (severity BETWEEN 1 AND 5),
    related_records INTEGER[],
    
    is_valid BOOLEAN DEFAULT TRUE,
    is_false_positive BOOLEAN DEFAULT FALSE,
    note TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_events_mission_id ON events(mission_id);
CREATE INDEX idx_events_type ON events(event_type);
CREATE INDEX idx_events_timestamp ON events(timestamp);

-- è»Šç«™è¡¨  
CREATE TABLE stations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
    
    name VARCHAR(100) NOT NULL,
    position INTEGER NOT NULL,
    platform_start INTEGER NOT NULL,
    platform_end INTEGER NOT NULL,
    
    arrival_time TIMESTAMP,
    departure_time TIMESTAMP,
    stop_position INTEGER,
    is_in_platform BOOLEAN DEFAULT FALSE,
    
    overrun_distance INTEGER DEFAULT 0,
    stop_accuracy_grade VARCHAR(10),
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_stations_mission_id ON stations(mission_id);
CREATE INDEX idx_stations_name ON stations(name);

-- Balise è¡¨
CREATE TABLE balises (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
    
    nid_bg INTEGER NOT NULL,
    position INTEGER NOT NULL,
    direction SMALLINT NOT NULL,
    
    telegram_count INTEGER DEFAULT 0,
    last_telegram_time TIMESTAMP,
    
    -- å°åŒ…è³‡æ–™ (JSON æ ¼å¼)
    movement_authority JSONB,
    speed_profile JSONB,
    gradient_profile JSONB,
    
    is_valid BOOLEAN DEFAULT TRUE,
    error_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_balises_mission_id ON balises(mission_id);
CREATE INDEX idx_balises_nid_bg ON balises(nid_bg);
CREATE INDEX idx_balises_position ON balises(position);

-- çµ„å“¡è¡¨ (ç”¨æ–¼è€ƒæ ¸)
CREATE TABLE crew_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL UNIQUE,
    employee_id VARCHAR(50) NOT NULL UNIQUE,
    department VARCHAR(100),
    position VARCHAR(50),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- çµ„å“¡è€ƒæ ¸è¨˜éŒ„è¡¨
CREATE TABLE crew_evaluations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
    crew_member_id UUID REFERENCES crew_members(id) ON DELETE CASCADE,
    
    evaluation_date DATE NOT NULL,
    
    -- è€ƒæ ¸é …ç›®
    eb_count INTEGER DEFAULT 0,
    sb_count INTEGER DEFAULT 0,
    false_sb_count INTEGER DEFAULT 0,
    overspeed_count INTEGER DEFAULT 0,
    stop_accuracy_score FLOAT,
    
    -- è©•åˆ†
    total_score FLOAT,
    grade VARCHAR(10),
    note TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_crew_evaluations_mission_id ON crew_evaluations(mission_id);
CREATE INDEX idx_crew_evaluations_member_id ON crew_evaluations(crew_member_id);
CREATE INDEX idx_crew_evaluations_date ON crew_evaluations(evaluation_date);
```

---

## 5. API è¨­è¨ˆè¦æ ¼

### 5.1 REST API ç«¯é»

### 5.1.1 æª”æ¡ˆç®¡ç† API

**ä¸Šå‚³æª”æ¡ˆ**

```
POST /api/v1/files/upload
Content-Type: multipart/form-data

Request Body:
{
    "ru_file": <binary>,
    "mmi_file": <binary>,
    "train_number": "1234",
    "driver_name": "å¼µä¸‰"
}

Response:
{
    "mission_id": "uuid",
    "status": "processing",
    "message": "æª”æ¡ˆä¸Šå‚³æˆåŠŸ,é–‹å§‹è™•ç†"
}
```

**æŸ¥è©¢è™•ç†ç‹€æ…‹**

```
GET /api/v1/missions/{mission_id}/status

Response:
{
    "mission_id": "uuid",
    "status": "completed",  // pending, processing, completed, failed
    "progress": 100,
    "message": "è™•ç†å®Œæˆ",
    "created_at": "2025-10-27T10:00:00Z",
    "completed_at": "2025-10-27T10:05:00Z"
}
```

### 5.1.2 è³‡æ–™æŸ¥è©¢ API

**æŸ¥è©¢ä»»å‹™åˆ—è¡¨**

```
GET /api/v1/missions?
    driver_name=å¼µä¸‰&
    start_date=2025-10-01&
    end_date=2025-10-27&
    page=1&
    page_size=20

Response:
{
    "total": 150,
    "page": 1,
    "page_size": 20,
    "missions": [
        {
            "id": "uuid",
            "train_number": "1234",
            "driver_name": "å¼µä¸‰",
            "start_time": "2025-10-27T08:00:00Z",
            "end_time": "2025-10-27T10:00:00Z",
            "total_distance": 50000,
            "max_speed": 130.5,
            "eb_count": 0,
            "sb_count": 2
        }
    ]
}
```

**æŸ¥è©¢è¨˜éŒ„è³‡æ–™**

```
GET /api/v1/missions/{mission_id}/records?
    start_time=2025-10-27T08:00:00Z&
    end_time=2025-10-27T09:00:00Z&
    packet_type=1

Response:
{
    "mission_id": "uuid",
    "total_records": 3600,
    "records": [
        {
            "timestamp": "2025-10-27T08:00:00Z",
            "speed": 80.5,
            "position": 1000,
            "packet_type": 1,
            "packet_data": {
                "v_train": 80.5,
                "l_train_pos": 100000,
                "m_mode": "FULL_SUPERVISION"
            }
        }
    ]
}
```

**æŸ¥è©¢äº‹ä»¶åˆ—è¡¨**

```
GET /api/v1/missions/{mission_id}/events?
    event_type=SB&
    severity_min=3

Response:
{
    "mission_id": "uuid",
    "events": [
        {
            "id": "uuid",
            "event_type": "SB",
            "timestamp": "2025-10-27T08:15:30Z",
            "position": 15000,
            "speed": 95.0,
            "description": "è¶…é€Ÿè§¸ç™¼ SB",
            "severity": 3,
            "is_false_positive": false
        }
    ]
}
```

### 5.1.3 åˆ†æ API

**é€Ÿåº¦æ›²ç·šè³‡æ–™**

```
GET /api/v1/missions/{mission_id}/speed-curve?
    mode=time  // time | distance

Response:
{
    "mission_id": "uuid",
    "mode": "time",
    "data": {
        "timestamps": ["2025-10-27T08:00:00Z", ...],
        "speeds": [0, 10.5, 20.3, ...],
        "positions": [0, 100, 250, ...],
        "atp_limits": [120, 120, 110, ...],
        "target_speeds": [80, 80, 70, ...]
    }
}
```

**åœè»Šç²¾æº–åº¦åˆ†æ**

```
GET /api/v1/missions/{mission_id}/stop-accuracy

Response:
{
    "mission_id": "uuid",
    "stations": [
        {
            "name": "å°åŒ—",
            "platform_start": 1000,
            "platform_end": 1200,
            "stop_position": 1100,
            "is_in_platform": true,
            "overrun_distance": 0,
            "grade": "A"
        }
    ]
}
```

**ç„¡ç«¯ SB åµæ¸¬**

```
GET /api/v1/missions/{mission_id}/false-sb

Response:
{
    "mission_id": "uuid",
    "false_sb_events": [
        {
            "timestamp": "2025-10-27T08:30:00Z",
            "position": 20000,
            "speed": 0.0,
            "reason": "æ›ç«¯æ™‚èª¤è§¸ç™¼",
            "is_confirmed": true
        }
    ]
}
```

### 5.1.4 å ±è¡¨ API

**ç”¢ç”Ÿçµ„å“¡è€ƒæ ¸å ±è¡¨**

```
POST /api/v1/reports/crew-evaluation
Content-Type: application/json

Request Body:
{
    "crew_member_id": "uuid",
    "start_date": "2025-10-01",
    "end_date": "2025-10-27",
    "format": "pdf"  // csv | excel | pdf
}

Response:
{
    "report_id": "uuid",
    "download_url": "/api/v1/reports/uuid/download",
    "expires_at": "2025-10-28T00:00:00Z"
}
```

**ä¸‹è¼‰å ±è¡¨**

```
GET /api/v1/reports/{report_id}/download

Response:
Content-Type: application/pdf
Content-Disposition: attachment; filename="crew_evaluation_20251027.pdf"
<binary data>
```

### 5.2 WebSocket API (å³æ™‚è³‡æ–™)

```jsx
// é€£æ¥ WebSocket
ws = new WebSocket('ws://[localhost:8000/ws/missions/{mission_id}](http://localhost:8000/ws/missions/{mission_id})')

// è¨‚é–±å³æ™‚é€Ÿåº¦è³‡æ–™
ws.send(JSON.stringify({
    type: 'subscribe',
    channel: 'speed_updates'
}))

// æ¥æ”¶å³æ™‚è³‡æ–™
ws.onmessage = (event) => {
    const data = JSON.parse([event.data](http://event.data))
    // {
    //     type: 'speed_update',
    //     timestamp: '2025-10-27T08:00:00Z',
    //     speed: 80.5,
    //     position: 1000
    // }
}
```

---

## 6. æ¸¬è©¦ç­–ç•¥

### 6.1 å–®å…ƒæ¸¬è©¦

### 6.1.1 è§£ç¢¼å™¨æ¸¬è©¦

```python
class TestRUDecoder(unittest.TestCase):
    def setUp(self):
        self.decoder = RUDecoder()
        self.test_data = self.load_test_data('test_ru.mmi')
    
    def test_record_header_parsing(self):
        """æ¸¬è©¦è¨˜éŒ„æ¨™é ­è§£æ"""
        header = RecordHeader.parse(self.test_data[:15])
        
        self.assertEqual(header.timestamp.year, 2025)
        self.assertAlmostEqual(header.speed, 80.5, delta=0.1)
        self.assertEqual(header.position, 1000)
        self.assertEqual(header.packet_type, 0xA0)
    
    def test_mmi_dynamic_decoding(self):
        """æ¸¬è©¦ MMI_DYNAMIC å°åŒ…è§£ç¢¼"""
        packet = MMIDynamic.decode(self.test_data[15:30])
        
        self.assertAlmostEqual(packet.v_train, 80.5, delta=0.1)
        self.assertEqual(packet.m_mode, ATPMode.FULL_SUPERVISION)
    
    def test_btm_reassembly(self):
        """æ¸¬è©¦ BTM 5 ç‰‡æ®µé‡çµ„"""
        reassembler = BTMReassembler()
        
        # åŠ å…¥ 5 å€‹ç‰‡æ®µ
        for i in range(5):
            fragment = self.load_fragment(i)
            result = reassembler.add_fragment(telegram_id=1, fragment_id=i, data=fragment)
            
            if i < 4:
                self.assertIsNone(result)  # å°šæœªå®Œæˆ
            else:
                self.assertIsNotNone(result)  # å®Œæˆé‡çµ„
                self.assertEqual(len(result), 128)  # å®Œæ•´é›»å ±é•·åº¦
```

### 6.1.2 è³‡æ–™çµæ§‹æ¸¬è©¦

```python
class TestATPMission(unittest.TestCase):
    def test_mission_creation(self):
        """æ¸¬è©¦ä»»å‹™å»ºç«‹"""
        mission = ATPMission(
            id=str(uuid.uuid4()),
            ru_filename='test.mmi',
            mmi_filename='test.mmi',
            upload_time=[datetime.now](http://datetime.now)(),
            train_number='1234',
            driver_name='æ¸¬è©¦å¸æ©Ÿ',
            start_station='å°åŒ—',
            end_station='é«˜é›„',
            records=[],
            events=[],
            stations=[],
            balises=[]
        )
        
        self.assertIsNotNone([mission.id](http://mission.id))
        self.assertEqual(mission.train_number, '1234')
    
    def test_event_filtering(self):
        """æ¸¬è©¦äº‹ä»¶ç¯©é¸"""
        events = [
            Event(..., event_type=EventType.EB, severity=5),
            Event(..., event_type=[EventType.SB](http://EventType.SB), severity=3),
            Event(..., event_type=EventType.WARNING, severity=1)
        ]
        
        high_severity_events = [e for e in events if e.severity >= 3]
        self.assertEqual(len(high_severity_events), 2)
```

### 6.2 æ•´åˆæ¸¬è©¦

### 6.2.1 ç«¯å°ç«¯æ¸¬è©¦

```python
class TestEndToEnd(unittest.TestCase):
    def test_complete_workflow(self):
        """æ¸¬è©¦å®Œæ•´å·¥ä½œæµç¨‹"""
        
        # 1. ä¸Šå‚³æª”æ¡ˆ
        ru_file = open('test_data/sample.mmi', 'rb')
        mmi_file = open('test_data/sample.mmi', 'rb')
        
        response = [self.client.post](http://self.client.post)('/api/v1/files/upload', files={
            'ru_file': ru_file,
            'mmi_file': mmi_file
        })
        
        self.assertEqual(response.status_code, 200)
        mission_id = response.json()['mission_id']
        
        # 2. ç­‰å¾…è™•ç†å®Œæˆ
        while True:
            status_response = self.client.get(f'/api/v1/missions/{mission_id}/status')
            status = status_response.json()['status']
            
            if status == 'completed':
                break
            elif status == 'failed':
                [self.fail](http://self.fail)('è™•ç†å¤±æ•—')
            
            time.sleep(1)
        
        # 3. æŸ¥è©¢è³‡æ–™
        records_response = self.client.get(f'/api/v1/missions/{mission_id}/records')
        records = records_response.json()['records']
        
        self.assertGreater(len(records), 0)
        
        # 4. æŸ¥è©¢äº‹ä»¶
        events_response = self.client.get(f'/api/v1/missions/{mission_id}/events')
        events = events_response.json()['events']
        
        # é©—è­‰äº‹ä»¶è³‡æ–™
        for event in events:
            self.assertIn(event['event_type'], [e.value for e in EventType])
```

### 6.3 å°ç…§é©—è­‰æ¸¬è©¦

**é—œéµ:** ä½¿ç”¨ Java ç³»çµ±çš„è¼¸å‡ºä½œç‚ºæ¸¬è©¦åŸºæº–

```python
class TestJavaCompatibility(unittest.TestCase):
    """å°ç…§ Java ç³»çµ±è¼¸å‡ºé€²è¡Œé©—è­‰"""
    
    def setUp(self):
        # è¼‰å…¥ Java ç³»çµ±çš„è¼¸å‡ºçµæœ
        [self.java](http://self.java)_output = self.load_java_reference('java_output.json')
    
    def test_decoder_output_matches_java(self):
        """é©—è­‰è§£ç¢¼å™¨è¼¸å‡ºèˆ‡ Java ç³»çµ±ä¸€è‡´"""
        
        # ä½¿ç”¨ç›¸åŒçš„æ¸¬è©¦æª”æ¡ˆ
        ru_file = 'test_data/sample.mmi'
        
        # Python è§£ç¢¼
        python_decoder = RUDecoder()
        python_records = python_decoder.decode_file(ru_file)
        
        # è¼‰å…¥ Java è§£ç¢¼çµæœ
        java_records = [self.java](http://self.java)_output['records']
        
        # æ¯”å°è¨˜éŒ„æ•¸é‡
        self.assertEqual(len(python_records), len(java_records))
        
        # é€ç­†æ¯”å°
        for i, (py_rec, java_rec) in enumerate(zip(python_records, java_records)):
            with self.subTest(record=i):
                # æ¯”å°æ™‚é–“æˆ³è¨˜
                self.assertEqual(
                    py_rec.timestamp.isoformat(),
                    java_rec['timestamp']
                )
                
                # æ¯”å°é€Ÿåº¦ (å…è¨± 0.1 km/h èª¤å·®)
                self.assertAlmostEqual(
                    py_rec.speed,
                    java_rec['speed'],
                    delta=0.1
                )
                
                # æ¯”å°ä½ç½® (å…è¨± 1 å…¬å°ºèª¤å·®)
                self.assertAlmostEqual(
                    py_rec.position,
                    java_rec['position'],
                    delta=1
                )
    
    def test_event_detection_matches_java(self):
        """é©—è­‰äº‹ä»¶åµæ¸¬èˆ‡ Java ç³»çµ±ä¸€è‡´"""
        
        python_events = self.detect_events('test_data/sample.mmi')
        java_events = [self.java](http://self.java)_output['events']
        
        # æ¯”å°äº‹ä»¶æ•¸é‡
        self.assertEqual(len(python_events), len(java_events))
        
        # æ¯”å°æ¯å€‹äº‹ä»¶
        for py_event, java_event in zip(python_events, java_events):
            self.assertEqual(py_event.event_type.value, java_event['type'])
            self.assertEqual(py_event.position, java_event['position'])
```

### 6.4 æ•ˆèƒ½æ¸¬è©¦

```python
class TestPerformance(unittest.TestCase):
    def test_large_file_processing(self):
        """æ¸¬è©¦å¤§æª”æ¡ˆè™•ç†æ•ˆèƒ½"""
        
        large_file = 'test_data/large_50mb.mmi'
        
        start_time = time.time()
        decoder = RUDecoder()
        records = decoder.decode_file(large_file)
        end_time = time.time()
        
        processing_time = end_time - start_time
        
        # æœŸæœ›: 50 MB æª”æ¡ˆåœ¨ 10 ç§’å…§è™•ç†å®Œæˆ
        self.assertLess(processing_time, 10.0)
        
        # æœŸæœ›: è‡³å°‘ç”¢ç”Ÿ 10000 ç­†è¨˜éŒ„
        self.assertGreater(len(records), 10000)
    
    def test_concurrent_processing(self):
        """æ¸¬è©¦ä¸¦è¡Œè™•ç†æ•ˆèƒ½"""
        
        files = [f'test_data/test_{i}.mmi' for i in range(10)]
        
        start_time = time.time()
        
        with ThreadPoolExecutor(max_workers=5) as executor:
            futures = [executor.submit(self.process_file, f) for f in files]
            results = [f.result() for f in futures]
        
        end_time = time.time()
        
        # æœŸæœ›: 10 å€‹æª”æ¡ˆä¸¦è¡Œè™•ç†æ™‚é–“ < åºåˆ—è™•ç†æ™‚é–“ / 3
        self.assertLess(end_time - start_time, 30.0)
```

---

## 7. Java â†’ Python å°ç…§æŒ‡å—

### 7.1 é¡åˆ¥å°ç…§è¡¨

| Java é¡åˆ¥ | Python é¡åˆ¥/æ¨¡çµ„ | èªªæ˜ |
| --- | --- | --- |
| [`Decoder.java`](http://Decoder.java) | `decoder/ru_[decoder.py](http://decoder.py)` | RU ä¸»è§£ç¢¼å™¨ |
| [`DecodeATP.java`](http://DecodeATP.java) | `decoder/atp_[decoder.py](http://decoder.py)` | ATP å°åŒ…è§£ç¢¼ |
| [`PacketMMI.java`](http://PacketMMI.java) | `decoder/mmi_[decoder.py](http://decoder.py)` | MMI å°åŒ…è§£ç¢¼ |
| [`HeadDecoder.java`](http://HeadDecoder.java) | `decoder/header_[parser.py](http://parser.py)` | æ¨™é ­è§£æå™¨ |
| [`BTMDecoder.java`](http://BTMDecoder.java) | `decoder/btm_[decoder.py](http://decoder.py)` | BTM è§£ç¢¼å™¨ |
| [`DataFeeder.java`](http://DataFeeder.java) | `decoder/data_[feeder.py](http://feeder.py)` | è³‡æ–™ä¾›çµ¦å™¨ |
| [`WaySideTelegramPacketDecoder.java`](http://WaySideTelegramPacketDecoder.java) | `decoder/wayside_[decoder.py](http://decoder.py)` | è·¯å´é›»å ±è§£ç¢¼ |
| `P3_[MovementAuthority.java](http://MovementAuthority.java)` | `models/packets/[p3.py](http://p3.py)` | P3 å°åŒ… |
| [`ATPMission.java`](http://ATPMission.java) | `models/[mission.py](http://mission.py)` | ä»»å‹™æ¨¡å‹ |

### 7.2 é—œéµå·®ç•°

### 7.2.1 ä½å…ƒçµ„åºè™•ç†

**Java:**

```java
// Big-Endian è®€å–
int value = (data[0] << 8) | (data[1] & 0xFF);
```

**Python:**

```python
# ä½¿ç”¨ struct æ¨¡çµ„
value = struct.unpack('>H', data[0:2])[0]
```

### 7.2.2 é›†åˆé¡åˆ¥

**Java:**

```java
// ä½¿ç”¨ Vector (åŒæ­¥åŒ–,è¼ƒæ…¢)
Vector<Record> records = new Vector<>();
records.add(record);
```

**Python:**

```python
# ä½¿ç”¨ List (æ›´å¿«)
records: List[Record] = []
records.append(record)
```

### 7.2.3 éŒ¯èª¤è™•ç†

**Java:**

```java
try {
    // è§£ç¢¼é‚è¼¯
} catch (Exception e) {
    // é€šå¸¸åªå°å‡ºéŒ¯èª¤,ä¸è™•ç†
    e.printStackTrace();
}
```

**Python:**

```python
try:
    # è§£ç¢¼é‚è¼¯
except struct.error as e:
    logger.error(f"è§£ç¢¼å¤±æ•—: {e}")
    raise DecoderException(f"å°åŒ…æ ¼å¼éŒ¯èª¤") from e
```

### 7.3 ç§»æ¤æ­¥é©Ÿ

**Step 1: åˆ†æ Java åŸå§‹ç¢¼**

```bash
# 1. æ‰¾å‡ºæ ¸å¿ƒé¡åˆ¥
grep -r "class.*Decoder" src_decompiled/

# 2. å»ºç«‹é¡åˆ¥ä¾è³´åœ–
javap -v *.class > dependencies.txt

# 3. è­˜åˆ¥é—œéµæ–¹æ³•
grep -r "public.*decode" src_decompiled/
```

**Step 2: å»ºç«‹å°ç…§è¡¨**

- åˆ—å‡ºæ‰€æœ‰ Java é¡åˆ¥
- è¦åŠƒå°æ‡‰çš„ Python æ¨¡çµ„
- è­˜åˆ¥å…±ç”¨é‚è¼¯

**Step 3: å¯¦ä½œæ ¸å¿ƒè§£ç¢¼å™¨**

```python
# å¾æœ€åº•å±¤é–‹å§‹å¯¦ä½œ
# 1. header_[parser.py](http://parser.py) (æ¨™é ­è§£æ)
# 2. mmi_[decoder.py](http://decoder.py) (MMI å°åŒ…)
# 3. btm_[decoder.py](http://decoder.py) (BTM é‡çµ„)
# 4. ru_[decoder.py](http://decoder.py) (ä¸»è§£ç¢¼å™¨)
```

**Step 4: å°ç…§é©—è­‰**

```python
# ä½¿ç”¨ Java ç³»çµ±çš„è¼¸å‡ºä½œç‚ºæ¸¬è©¦åŸºæº–
java_output = load_java_reference('test_case_1.json')
python_output = python_decoder.decode('test_case_1.mmi')

assert_equal(python_output, java_output)
```

**Step 5: æ•ˆèƒ½å„ªåŒ–**

```python
# ä½¿ç”¨ cProfile æ‰¾å‡ºç“¶é ¸
python -m cProfile -o [output.prof](http://output.prof) [main.py](http://main.py)

# å„ªåŒ–ç†±é»å‡½æ•¸
# - ä½¿ç”¨ struct ä»£æ›¿æ‰‹å‹•ä½å…ƒçµ„æ“ä½œ
# - ä½¿ç”¨ NumPy åŠ é€Ÿæ•¸å€¼é‹ç®—
# - ä½¿ç”¨ concurrent.futures å¹³è¡Œè™•ç†
```

---

## 8. éƒ¨ç½²èˆ‡ç¶­è­·

### 8.1 ç³»çµ±éœ€æ±‚

**ç¡¬é«”éœ€æ±‚:**

- CPU: 4 æ ¸å¿ƒä»¥ä¸Š
- RAM: 8 GB ä»¥ä¸Š
- ç¡¬ç¢Ÿ: 100 GB ä»¥ä¸Š (SSD å»ºè­°)

**è»Ÿé«”éœ€æ±‚:**

- OS: macOS, Linux, Windows
- Python: 3.9+
- PostgreSQL: 13+
- Redis: 6+ (å¿«å–)

### 8.2 å®‰è£éƒ¨ç½²

**Step 1: ç’°å¢ƒè¨­å®š**

```bash
# å»ºç«‹è™›æ“¬ç’°å¢ƒ
python -m venv venv
source venv/bin/activate  # macOS/Linux
# venv\Scripts\activate  # Windows

# å®‰è£ç›¸ä¾å¥—ä»¶
pip install -r requirements.txt
```

**Step 2: è³‡æ–™åº«è¨­å®š**

```bash
# å»ºç«‹è³‡æ–™åº«
createdb atp_analysis

# åŸ·è¡Œ Schema
psql atp_analysis < schema.sql

# å»ºç«‹ç´¢å¼•
psql atp_analysis < indexes.sql
```

**Step 3: è¨­å®šæª”**

```yaml
# config.yaml
database:
  host: [localhost](http://localhost)
  port: 5432
  name: atp_analysis
  user: postgres
  password: your_password

redis:
  host: [localhost](http://localhost)
  port: 6379

file_storage:
  base_path: /Users/lawliet/dev-workspace/atp-data
  max_size_mb: 100

logging:
  level: INFO
  file: logs/atp.log
```

**Step 4: å•Ÿå‹•æœå‹™**

```bash
# å•Ÿå‹• API ä¼ºæœå™¨
uvicorn main:app --host 0.0.0.0 --port 8000 --reload

# å•Ÿå‹•èƒŒæ™¯å·¥ä½œç¨‹åº
celery -A tasks worker --loglevel=info

# å•Ÿå‹• Web UI
streamlit run [app.py](http://app.py) --server.port 8501
```

### 8.3 ç›£æ§ç¶­è­·

**æ—¥èªŒç›£æ§:**

```python
# ä½¿ç”¨ structlog é€²è¡Œçµæ§‹åŒ–æ—¥èªŒ
import structlog

logger = structlog.get_logger()
[logger.info](http://logger.info)("decoder.start", mission_id=mission_id, file_size=file_size)
logger.error("decoder.failed", mission_id=mission_id, error=str(e))
```

**æ•ˆèƒ½ç›£æ§:**

```python
# ä½¿ç”¨ Prometheus æ”¶é›†æŒ‡æ¨™
from prometheus_client import Counter, Histogram

decode_duration = Histogram('atp_decode_duration_seconds', 'Decode duration')
decode_errors = Counter('atp_decode_errors_total', 'Total decode errors')

@decode_duration.time()
def decode_file(filename):
    try:
        # è§£ç¢¼é‚è¼¯
        pass
    except Exception as e:
        decode_[errors.inc](http://errors.inc)()
        raise
```

**å‚™ä»½ç­–ç•¥:**

```bash
# æ¯æ—¥å‚™ä»½è³‡æ–™åº«
pg_dump atp_analysis > backup_$(date +%Y%m%d).sql

# æ¯é€±å‚™ä»½ä¸Šå‚³æª”æ¡ˆ
tar -czf uploads_$(date +%Y%m%d).tar.gz /Users/lawliet/dev-workspace/atp-data/
```

### 8.4 ç–‘é›£æ’è§£

**å¸¸è¦‹å•é¡Œ:**

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
| --- | --- | --- |
| è§£ç¢¼å¤±æ•— | æª”æ¡ˆæ ¼å¼éŒ¯èª¤ | æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§ |
| è¨˜æ†¶é«”ä¸è¶³ | å¤§æª”æ¡ˆè™•ç† | å¢åŠ  RAM æˆ–ä½¿ç”¨ä¸²æµè™•ç† |
| è™•ç†é€Ÿåº¦æ…¢ | CPU æ•ˆèƒ½ä¸è¶³ | ä½¿ç”¨å¤šåŸ·è¡Œç·’æˆ–æ›´å¿«çš„ CPU |
| è³‡æ–™åº«é€£ç·šå¤±æ•— | PostgreSQL æœªå•Ÿå‹• | æª¢æŸ¥è³‡æ–™åº«æœå‹™ç‹€æ…‹ |

**é™¤éŒ¯æ¨¡å¼:**

```bash
# å•Ÿç”¨è©³ç´°æ—¥èªŒ
export ATP_LOG_LEVEL=DEBUG
python [main.py](http://main.py)

# ä½¿ç”¨ pdb é™¤éŒ¯
python -m pdb [main.py](http://main.py)
```

---

## é‡è¦æé†’

**é€™ä»½è¦æ ¼æ›¸æ˜¯å¾ Java åŸå§‹ç³»çµ±å®Œæ•´ç§»æ¤åˆ° Python çš„æŒ‡å—ï¼š**

1. **100% å°ç…§åŸå‰‡**ï¼šæ‰€æœ‰è§£ç¢¼é‚è¼¯å¿…é ˆèˆ‡ Java ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
2. **æ¸¬è©¦é©…å‹•**ï¼šä½¿ç”¨ Java ç³»çµ±çš„è¼¸å‡ºä½œç‚ºæ¸¬è©¦åŸºæº–
3. **ä¿ç•™æ ¸å¿ƒåƒ¹å€¼**ï¼šJava ç³»çµ±ç¶“é 10+ å¹´é©—è­‰ï¼Œä¸å¯éš¨æ„æ›´æ”¹é‚è¼¯
4. **ç¾ä»£åŒ–æ”¹é€²**ï¼šåœ¨ä¿è­‰é‚è¼¯æ­£ç¢ºçš„å‰æä¸‹ï¼Œä½¿ç”¨ç¾ä»£å·¥å…·æå‡æ•ˆèƒ½

**é—œéµæˆåŠŸå› ç´ ï¼š**

- âœ… è©³ç´°é–±è®€ Java åŸå§‹ç¢¼
- âœ… ç‚ºæ¯å€‹æ¨¡çµ„å»ºç«‹å°ç…§æ¸¬è©¦
- âœ… ä½¿ç”¨å¯¦éš› RU æª”æ¡ˆé©—è­‰
- âœ… ä¿æŒèˆ‡ Java åœ˜éšŠæºé€š

---

## ä¸‹ä¸€æ­¥è¡Œå‹•

**ç«‹å³å¯åšï¼š**

1. è¨­å®šé–‹ç™¼ç’°å¢ƒï¼ˆPython 3.11+, PostgreSQLï¼‰
2. Clone Java åŸå§‹ç¢¼åˆ° `reference/` ç›®éŒ„
3. æº–å‚™æ¸¬è©¦è³‡æ–™ï¼ˆå¯¦éš› RU æª”æ¡ˆ + Java è¼¸å‡ºï¼‰
4. é–‹å§‹å¯¦ä½œæ ¸å¿ƒè§£ç¢¼å™¨

**é–‹ç™¼é †åºå»ºè­°ï¼š**

```
éšæ®µ 1 (2-3é€±): æ ¸å¿ƒè§£ç¢¼å™¨
  â”œâ”€ PacketHeaderParser
  â”œâ”€ MMIDecoder (å…ˆå¯¦ä½œ MMI_DYNAMIC)
  â”œâ”€ BTMDecoder
  â””â”€ å–®å…ƒæ¸¬è©¦ + Java å°ç…§é©—è­‰

éšæ®µ 2 (1-2é€±): è³‡æ–™æ¨¡å‹
  â”œâ”€ ATPMission
  â”œâ”€ DatabaseManager
  â””â”€ æ•´åˆæ¸¬è©¦

éšæ®µ 3 (2-3é€±): è¦–è¦ºåŒ–
  â”œâ”€ SpeedCurveDrawer
  â”œâ”€ EventDrawer
  â””â”€ äº’å‹•å¼åœ–è¡¨

éšæ®µ 4 (1-2é€±): Web UI
  â”œâ”€ Streamlit ä¸»ä»‹é¢
  â”œâ”€ æª”æ¡ˆä¸Šå‚³åŠŸèƒ½
  â””â”€ å ±è¡¨ç”¢å‡º
```

**è¯çµ¡æ–¹å¼ï¼š**

- é–‹ç™¼è€…ï¼šLawliet
- å–®ä½ï¼š
- å°ˆæ¡ˆè·¯å¾‘ï¼š`/Users/lawliet/dev-workspace/atp-analysis-python`

---

**æ–‡ä»¶ç‰ˆæœ¬ï¼š** 2.0

**æœ€å¾Œæ›´æ–°ï¼š** 2025-10-27

**ç‹€æ…‹ï¼š** è¦æ ¼æ›¸å®Œæˆï¼Œæº–å‚™é–‹å§‹å¯¦ä½œ

---

## é™„éŒ„ï¼šå¿«é€Ÿåƒè€ƒ

### å°ˆæœ‰åè©

- **ATP**: Automatic Train Protection (åˆ—è»Šè‡ªå‹•é˜²è­·ç³»çµ±)
- **MMI**: Man-Machine Interface (äººæ©Ÿä»‹é¢)
- **RU**: Recording Unit (è¨˜éŒ„å–®å…ƒ)
- **BTM**: Balise Transmission Module (åœ°é¢æ‡‰ç­”å™¨å‚³è¼¸æ¨¡çµ„)
- **EB**: Emergency Brake (ç·Šæ€¥ç…è»Š)
- **SB**: Service Brake (å¸¸ç”¨ç…è»Š)
- **ETCS**: European Train Control System (æ­æ´²åˆ—è»Šæ§åˆ¶ç³»çµ±)

### é‡è¦å°åŒ…

- **MMI_DYNAMIC (1)**: å‹•æ…‹è³‡æ–™ï¼ˆé€Ÿåº¦ã€ä½ç½®ï¼‰â­
- **MMI_STATUS (2)**: ç³»çµ±ç‹€æ…‹ â­
- **MMI_DRIVER_MESSAGE (8)**: å¸æ©Ÿå“¡è¨Šæ¯ â­
- **MMI_FAILURE_REPORT_ATP (9)**: ATP æ•…éšœ â­
- **P3**: Movement Authority (è¡Œè»Šæ¬Šé™) â­
- **P27**: Speed Profile (é€Ÿåº¦é™åˆ¶) â­

### é—œéµæª”æ¡ˆä½ç½®

**Java åŸå§‹ç¢¼ï¼š**

- å°ˆæ¡ˆæª”æ¡ˆï¼š`/mnt/project/`
- æœ¬åœ°åƒè€ƒï¼š`/Users/lawliet/dev-workspace/atp-analysis-python/reference/`

**Python å°ˆæ¡ˆï¼š**

- ä¸»ç›®éŒ„ï¼š`/Users/lawliet/dev-workspace/atp-analysis-python/`
- æ¸¬è©¦è³‡æ–™ï¼š`tests/test_data/`
- Java è¼¸å‡ºåƒè€ƒï¼š`tests/java_reference_outputs/`